#!/bin/bash
#
# Downloads and extracts the latest ported releases from GitHub

printSoftError()
{
  printf "${NC}${RED}${BOLD}***ERROR: ${NC}${RED}${1}${NC}\n" >&2
}

printError()
{
  printSoftError "${1}"
  exit 4
}

while [[ $# -gt 0 ]]; do
  #TODO: add support to download specific ports
  case "$1" in
    "-d")
      download=$2;
      shift
      ;;
    "-t")
      toolrepo=$2;
      shift
      ;;
    *)
      printError "Unknown option ${1} specified"
      ;;
  esac
  shift;
done

if [ ! -z ${download} -a -d ${download} ]; then
  pushd ${download}
fi

#FIXME: Once jq is ported, rewrite with jq
for repo in $(curl -s "https://api.github.com/users/ZOSOpenTools/repos?per_page=100" | grep "\"full_name\":" | cut -d '"' -f 4); do
  repo=${repo#"ZOSOpenTools/"}
  echo $repo
  if [ ! -z "${toolrepo}" -a "${toolrepo}" == "${repo}" ]; then
    URL=$(curl -s https://api.github.com/repos/ZOSOpenTools/${repo}/releases/latest | grep browser_download_url | cut -d '"' -f 4)
    if [ "${URL}" == "" ]; then
      continue;
    fi
    curl -L ${URL} -O
    pax=$(basename ${URL})
    pax -rf $pax
  fi
done

if [ ! -z ${download} -a -d ${download} ]; then
  popd
fi
